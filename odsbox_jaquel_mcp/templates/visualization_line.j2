import matplotlib.pyplot as plt

# Number of submatrices
num_of_plots = {{ submatrices_count }}

# Calculate number of rows
cols = {{ subplots_per_row }}
rows = (num_of_plots + cols - 1) // cols  # Ceiling division

fig, axes = plt.subplots(
    rows, cols,
    figsize=({{ figsize_width }}, {{ figsize_height_per_row }} * rows)
)
axes = axes.flatten()  # Flatten to 1D array for easy indexing

quantity_names = [{% for qty in measurement_quantity_names %}"{{ qty }}"{{ "," if not loop.last }}{% endfor %}]

for i, measurement_data in enumerate(measurement_data_items):
    ax = axes[i]

    for qty in quantity_names:
        if qty in measurement_data["data"].columns:
            ax.plot(
                measurement_data["data"].index,
                measurement_data["data"][qty],
                label=measurement_data["labels"].get(qty, qty),
                marker='o',
                markersize=4
            )

    ax.set_xlabel('Time')
    ax.set_ylabel('Value')
    ax.set_title(measurement_data["title"])
    ax.legend()
    ax.grid(True, alpha=0.3)

# Hide any unused subplots
for j in range(i + 1, len(axes)):
    axes[j].axis('off')

plt.tight_layout()
plt.show()
